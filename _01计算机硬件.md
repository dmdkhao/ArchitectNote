# 计算机硬件

## 一、目标

* 硬件组成
* 校验码
* 指令系统
* 存储系统
* 输入与输出
* 总线

## 二、硬件组成

​	计算机组成：运算器、控制器、存储器、输入设备、输出设备。

运算器：负责**算术运算**与**逻辑运算**。

控制器：负责**程序控制**、**操作控制**、**时间控制**

存储器 = 内存 + 外存

输入输出设备：负责数据的流转。

### 2.1 CPU

​	CPU 全称Central Processing Unit中央运算单元。运算器+控制器 = CPU。

CPU依据**指令周期**不同阶段区分**指令**与**数据**。

#### 2.1.1 运算器

ALU：算数逻辑单元，负责**算术运算**与**逻辑运算**。

AC：累加寄存器，负责**存放运算结果或源操作数**。

DR：数据缓冲寄存器，**暂时存放内存的指令或数据**。

PSW：状态条件寄存器，保存指令运行结果的条件码内容，如**溢出标志**。

#### 2.1.2 控制器

PC：程序计数器，存放下一条指令执行地址。

IR：指令寄存器，暂存CPU执行指令

ID：指令译码器，分析指令操作码

AR：保存当前CPU所访问的内存地址

## 三、校验码

​	当前主要有3种校验码：

1. 奇偶校验码
2. CRC循环冗余校验码
3. 海明校验码

**码距**：在两个编码中，从A码到B码转换所需改变的位数称为码距。

​	例如：A:00  ----> B:11 则码距=2。

### 3.1 奇偶校验码

​	通过在最右增加**1位**校验位来使得编码中1的个数为奇数（奇校验）或偶数（偶校验）。

​	例如： 源码10110。 若使用奇校验则得到101100。若使用偶校验则得到101101。

局限：

* 只能检1位错（若同时错2位则无法检测）
* 没法纠错

### 3.2 CRC循环冗余校验码

​	CRC只能检错，不能纠错。使用CRC需要事先双方**约定一个生成多项式G(x)**。生成多项式最高位和最低为**必须是1**。通过**原始数据**和**生成多项式**运算得出**若干校验位**。将**校验位**追加在原始数据**右侧**则获得完整数据。接收方收到**带有校验位**的数据后，用G(x)整除，若**余数为0**则表示没有错误，反之发生错误。过程如下：

**例**： 设原始信息串为10110，CRC生成多项式为G(x) = x^4+x+1。求CRC校验码

1. **在原始信息位后面添0，假设生成多项式最高阶为r，则原始信息位后面添加r个0。**本例题中最高阶为4则在后面添加4个0，得到新串101100000，**并作为被除数**。
2. **由多项式得到除数**。**多项式中x幂指数存在的位置1，不存在位置0。**本题中为10011(x0次幂有，1次幂有，2次幂无，3次幂无，4次幂有，从右往左写即为10011).
3. 生成CRC校验码，将前两步得到的串进行模2运算（异或）。所得**余数**作为校验码拼接到原始信息串右侧。本例题中101100000和10011模2运算得出1111

![image-20240818201932717](https://zhspic.oss-cn-beijing.aliyuncs.com/md/image-20240818201932717.png)

4. 故完整CRC校验码为101101111。

## 四、指令

​	计算机指令由**操作码**和**地址码**组成。操作码存放当前操作类型；地址码存放具体操作数的地址。地址码可能由多块组成。

![image-20240820095917465](https://zhspic.oss-cn-beijing.aliyuncs.com/md/image-20240820095917465.png)

### 4.1 指令执行过程

1. 取指令
2. 分析指令
3. 执行指令
   1. 取操作数

### 4.2 指令寻址方式

* 顺序寻址方式：PC程序计数器始终会指向下一条指令地址。
* 跳跃寻址方式：下一条指令地址码由当前指令直接给出。

### 4.3 指令操作数寻址方式

* **立即寻址方式**：地址码中不是地址而是操作数本身。
* **直接寻址方式**：地址码为主存地址，该地址存放操作数。![image-20240820100712733](https://zhspic.oss-cn-beijing.aliyuncs.com/md/image-20240820100712733.png)
* **间接寻址方式**：地址码为主存地址，主存地址上存放操作数地址，操作数地址上存放操作数。![image-20240820100818181](https://zhspic.oss-cn-beijing.aliyuncs.com/md/image-20240820100818181.png)
* 寄存器寻址方式：地址码为寄存器编号。

### 4.4 指令系统

* CISC(Complex Instruction Set Computing)：**复杂指令系统**，兼容性强，指令多，长度可变。
* RISC(Reduced Instruction-Set Computer)：**精简指令系统，依靠硬件实现，通用寄存器，硬布线逻辑控制，适合采用流水线**。

### 4.5 流水线

#### 4.5.1 流水线概述

​	将指令分成不同段，每段由不同部件处理。采取叠加思想。

一般将指令执行分成三段：

![image-20240820105825471](https://zhspic.oss-cn-beijing.aliyuncs.com/md/image-20240820105825471.png)

 RISC使用流水线技术，CISC没有使用流水线技术。

未使用流水线的指令执行如下：（途中指令执行拆成了五个环节）

![image-20240820110556336](https://zhspic.oss-cn-beijing.aliyuncs.com/md/image-20240820110556336.png)

使用流水线的指令执行如下：

![image-20240820110603625](https://zhspic.oss-cn-beijing.aliyuncs.com/md/image-20240820110603625.png)

​	可以看出，指令流水线本质上是一种**时间并行技术**。

#### 4.5.2 流水线的种类

1. 超流水线技术：细化指令段，比如原本三段分成五段。时间换空间。
2. 超标量技术：加装多条流水线，同时执行多个处理。空间换时间。
3. 超长指令字：类似超标量技术，加装软件提高并行效率，空间换时间。

#### 4.5.3 流水线计算

​		例题设定：一条指令分为4段，分别为1us,3us,5us,2us。执行100条。(1s = 10^9ns = 10^6us)

**流水线周期**：指令分成不同执行段，其中执行时间最长的段为流水线周期。

​	例题：流水线周期=5us。

**流水线执行时间** = 1条指令总执行时间+(总指令条数-1) * 流水线周期

​	例如：(1+3+5+2) + (100-1) * 5 

​				 = 11 + 99*5

​				 = 506us

**流水线吞吐量**：单位时间内执行的指令条数。计算公式为：指令条数/流水线执行时间

​	例如：100/506us=197*10^3/s

**流水线加速比**：使用流水线比不使用流水线效率提升多少倍。计算公式为：(不使用执行时间)/(使用执行时间)

​	例题：(1+3+5+2)*100/506 = 2.17

## 五、存储系统

​	当今计算机存储类型大概有以下五级：CPU内部寄存器、cache高速缓存、主存储器、联机磁盘存储器、脱机光盘/磁盘存储器。他们关系如图所示：

![image-20240821160058187](https://zhspic.oss-cn-beijing.aliyuncs.com/md/image-20240821160058187.png)

### 5.1 分级存储

​	分级存储的目的为**解决存储容量、成本和速度之间的矛盾**。

​	**两级存储**：Cache--主存、主存--辅存（虚拟存储技术）

### 5.2 局部性原理

​		cache称为高速缓存，当中存放CPU常用数据。当CPU需要数据时，会先访问Cache，若**命中**则返回数据，若非命中则再访问主存。

* **时间局部性**原理：**相邻时间可能访问同一个数据项**，即近期访问的数据在不久的将来可能会再次被访问到。
* **空间局部性**原理：**相邻的空间地址会被连续访问**，即将来用到的数据很有可能时当前数据项地址附近的数据。

### 5.3 Cache

​	**1. cache概述及组成**

​	高速缓存Cache用于**存储当前最活跃的程序和数据，直接与CPU交互，位于CPU和主存之间**。容量小，速度快(约为主存的5~10倍)，内容为主存的**副本拷贝**，对于程序员是透明的。

​	cache由**控制部分**和**存储器**组成。存储器用于存储数据。

* 控制部分：判断CPU要访问的数据是否在Cache中，在则命中，不在则依据**一定算法从主存中替换**(地址映射)。

​	**2. 地址映像**

​	在CPU工作时，CPU给出的是主存地址，而应当从Cache中读/写数据。需要**地址映射将主存地址转换为Cache存储器地址**，**由硬件自动完成映射**。常用下列三种方法：

* 地址映像算法：
  * 直接映像
  * 全相联映像
  * 组组相连映像

​	**3. Cache替换算法**

​	Cache算法能够替换Cache中不常用的数据。

* **常见算法**：
  * 随机替换RAND：随机替换Cache中与主存中的数据。
  * 先进先出FIFO：将最先进入Cache中的数据替换出去。
  * **近期最少使用算法LRU**：将近期Cache中最少使用的数据块替换出去。**效率最高**。为Cache块设置一个**计数器**，记录每个Cache块**有多少次没被使用**（命中时该块清零，计数器比它低的+1，其余不变），发生替换时只需要替换最大数的块即可。LRU基于**局部性-时间局部性原理**，即近期访问的数据在不久的将来可能会再次被访问到。
  * 优化替换算法：先执行一次程序，**统计Cache替换情况**(**先验信息**)。有了先验信息，在第二次执行时便可以用更有效的方式替换。

​	**4. Cache命中率、平均时间**

​	Cache命中率指：当CPU访问数据在Cache命中时，则直接从Cache中读取数据；若CPU访问的数据不在Cache时，则再到主存中读取数据。因此可以认为若Cache的容量足够大甚至与主存相同时（实际上并不可能），则命中率可以达到100%。

![image-20240821162314154](https://zhspic.oss-cn-beijing.aliyuncs.com/md/image-20240821162314154.png)

​	假定CPU多次读取数据，90%概率命中Cache，10%概率访问主存。访问Cache耗时1ns，访问主存耗时1000ns。则**平均时间**为`(90%*1+10%*1000)`

### 5.4 存储系统详情

**概述**

​	硬盘内部类似光盘，光盘表面称为**盘面**，盘面上由一个个同心圆组成，同心圆上的凹痕称为**磁道**。由圆心发射光盘周围组成的区域为**扇区**。硬盘形状如下图所示：

![image-20240821212946557](https://zhspic.oss-cn-beijing.aliyuncs.com/md/image-20240821212946557.png)

​	通常一个磁盘由多个盘片叠加而成。每个盘面对应一个**磁头**，所有磁头连接一个**磁臂**上，因此所有磁头只能共进退。

​	所有盘面中**相对位置相同的磁道**组成柱面。

![image-20240821213405993](https://zhspic.oss-cn-beijing.aliyuncs.com/md/image-20240821213405993.png)

​	综上，可用（柱面号（或磁道号），盘面号，扇区号）来定义任意一个磁盘块。

**寻址**

​	磁盘如何寻址？流程如下

* 1. 磁头移动到指定磁道

  2. 磁盘旋转，使得磁头转到指定扇区并读取数据。

     ​	**读取时间 = 寻道时间 + 旋转时间**

**磁盘调度算法**

​	旋转时间无太大提升空间，因此人们通过**减少寻道时间**来**减少读取时间**。减少寻道时间通常采用以下几种算法：

1. 先来先服务FCFS：根据进程访问磁盘先后顺序完成调度。
2. 最短寻道时间优先SSTF：磁头**优先移动**到**这批请求**中**距离最近**的磁道上。但缺点容易产生饥饿现象。
3. **扫描算法SCAN**：又称电梯算法，双向扫描。磁头向最近请求磁道做寻道，**直到该方向上无请求后调转方向**继续寻道。
4. 单向扫描算法CSCAN：磁头只做单向移动，一直移动到最外侧磁道再调转方向。

**计算题**

![image-20240821220038421](https://zhspic.oss-cn-beijing.aliyuncs.com/md/image-20240821220038421.png)



## 六、输入输出技术

### 6.1 输入输出

​	计算机中存在多种**内存与接口地址的编址方法**。分别是：**内存与接口地址独立编址方法** 和 **内存与接口统一编址方法**。

* 独立编址方法：内存与接口的**地址空间独立**，**访问数据时使用指令不同**。存在缺点：接口指令少，功能弱。
* 统一编址方法：内存地址与接口地址统一在一个**公共的地址空间**里。内存与接口共用地址空间。
  * 优点：理论上用于内存的指令可以完全应用于接口。大幅增强了接口的操作功能。
  * 缺点：地址空间被划分成两块(一块内存、一块接口)，进而导致内存地址不连续。

### 6.2 计算机与外设交互方式

​	计算机与外设交互方式通俗来讲为：外设数据是怎样被计算机读取，或计算机是怎样将数据发给外设设备。常见方式有以下三种：

1. 程序控制(查询)方式：CPU主动查询外设是否完成数据传输。效率极低。
2. 程序中断方式：外设完成数据传输后发起**中断请求**，CPU收到中断请求后，完成手头指令后去进行数据交互。
3. **DMA方式（直接主存存取）**：Direct Memory Access在主存与外设之间建立一个直接的数据通道。CPU基本不参与数据传输（除了CPU需要完成必要的初始化操作，例如初始化DMA和启动DMA）。这种方式效率极高

时机

* 在一个总线周期结束后，CPU会响应DMA请求并开始读取数据。
* 在一个指令执行结束后，CPU会响应程序中断。

## 七、总线

### 7.1 总线说明

​	总线为计算机中**数据传输的通道**或**数据通道**。

### 7.2 总线分类

​	按照分类角度不同，分出的类别也不同。

按照内外进行分类为

1. 内部总线：芯片级别总线，分布在芯片内部，通常肉眼观测不到。
2. 系统总线：主板级别总线，连接硬件系统中各部件。根据功能又分为：
   1. 地址总线
   2. 数据总线
   3. 控制总线
3. 外部总线：设备级别总线，连接多外部硬件设备。

根据串并行分为

1. 串行总线：适用于长距离，传输速度慢。
2. 并行总线：适用于短距离，传输速度块。

根据单双分为： “假设当前有A和B两个对象”

1. 单工：只能由A传输B。
2. 半双工：可以A传B，也可以B传A，**但是同一时刻只能有一个传**。
3. 全双工：任意时刻都可以双向传输。